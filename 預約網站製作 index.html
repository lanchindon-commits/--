<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ©Ÿè»Šé ç´„æœå‹™ç¶²ç«™</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 550px;
            margin: 0 auto;
            padding: 8px;
            position: relative;
        }
        
        canvas {
            width: 100% !important;
            height: auto !important;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            background-color: #ffffff;
            touch-action: manipulation;
            cursor: pointer;
        }

        .form-control {
            margin-bottom: 0.75rem;
        }
        .form-control label {
            display: block;
            font-weight: bold;
            margin-bottom: 0.25rem;
            color: #1f2937;
            font-size: 14px;
        }
        .form-control input, .form-control textarea {
            width: 100%;
            padding: 0.65rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        #loadingOverlay, #customModal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }
        
        /* ä»¿åœ–ç‰‡æ¨£å¼çš„å½ˆçª—å…§å®¹ */
        .modal-content {
            background: white;
            padding: 32px 24px;
            border-radius: 16px;
            max-width: 420px;
            width: 100%;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #lineLinkOverlay {
            position: absolute;
            display: none;
            background-color: rgba(0,0,0,0);
            z-index: 100;
            cursor: pointer;
        }
        
        #datePicker {
            -webkit-appearance: none;
            width: 100%;
            max-width: 100%;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans pb-6">

    <!-- è¼‰å…¥ä¸­é®ç½© -->
    <div id="loadingOverlay">
        <div class="flex flex-col items-center bg-white p-6 rounded-lg">
            <div class="spinner"></div>
            <p id="loadingText" class="mt-4 text-blue-600 font-bold text-sm">é ç´„è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</p>
        </div>
    </div>

    <!-- è‡ªå®šç¾©æç¤ºå½ˆçª— -->
    <div id="customModal">
        <div class="modal-content">
            <div class="text-amber-500 mb-4">
                <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-4">é ç´„æé†’</h3>
            <p class="text-base text-gray-700 leading-relaxed mb-8 px-2">
                è‹¥æ‚¨é¸æ“‡ <span class="text-blue-600 font-semibold">ã€æ¸…æ´—ç¯€æµé–¥ã€‘</span>ã€<span class="text-blue-600 font-semibold">ã€æ¸…æ´—å™´æ²¹å˜´ã€‘</span> æˆ– <span class="text-blue-600 font-semibold">ã€å‰å‰ä¿é¤Šã€‘</span>ï¼Œå› ä½œæ¥­æ™‚é–“è¼ƒé•·ï¼Œå°‡ä»¥ <span class="text-red-600 font-bold">ç•™è»Šæ–¹å¼</span>ï¼Œä»¥åˆ©æˆ‘å€‘å®‰æ’æ–½å·¥ï¼Œè¬è¬æ‚¨çš„é…åˆèˆ‡é«”è«’ã€‚
            </p>
            <button id="modalConfirmBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl transition-all shadow-md active:scale-95">
                æˆ‘çŸ¥é“äº†ï¼Œç¹¼çºŒé ç´„
            </button>
        </div>
    </div>

    <div id="container">
        <h1 class="text-xl font-bold text-center text-blue-700 py-3 w-full">æ©Ÿè»Šæœå‹™é ç´„ç³»çµ±</h1>

        <!-- æ­¥é©Ÿ 1 æ—¥æœŸé¸æ“‡å€ -->
        <div id="step1Control" class="w-full bg-blue-50 p-3 rounded-t-lg border-t border-x border-blue-200 box-border">
            <h3 class="text-base font-semibold mb-2 text-blue-600">æ­¥é©Ÿ 1: é¸æ“‡æ—¥æœŸ</h3>
            <div class="w-full overflow-hidden">
                <input type="date" id="datePicker" class="p-2 border border-blue-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 outline-none bg-white">
            </div>
            <div class="text-[10px] text-gray-500 mt-2 grid grid-cols-2 gap-1">
                <p class="text-red-500">â€» é™é ç´„æ˜å¤©é–‹å§‹30å¤©å…§</p>
                <p class="text-red-500 font-semibold">â€» é€±æ—¥å…¨åº—å…¬ä¼‘</p>
                <p>â€» é‡‘åŠ›ç››é€±å…­ä¼‘æ¯</p>
                <p class="text-red-600">â€» å…ƒæ—¦/æ¸…æ˜/ç«¯åˆ/ä¸­ç§‹å…¬ä¼‘</p>
            </div>
        </div>

        <!-- ç•«å¸ƒäº’å‹•å€ -->
        <div class="relative w-full">
            <canvas id="reservationCanvas" width="550" height="730"></canvas>
            <a id="lineLinkOverlay" href="https://lin.ee/E0OUGxq" target="_blank"></a>
        </div>

        <!-- æ­¥é©Ÿ 4 å¡«å¯«è³‡æ–™å€ -->
        <div id="htmlInputs" class="w-full">
            <div id="step4Control" style="display:none;" class="bg-white p-5 rounded-b-lg shadow-md border-x border-b border-gray-200">
                <h3 class="text-lg font-bold mb-4 text-blue-700 border-b pb-2 text-center">æ­¥é©Ÿ 4: å¡«å¯«è¯ç¹«è³‡æ–™</h3>
                
                <div class="form-control">
                    <label>ç¨±è¬‚:</label>
                    <div class="flex space-x-6 p-2 bg-gray-50 rounded">
                        <label class="flex items-center"><input type="radio" name="userTitle" value="å…ˆç”Ÿ" checked class="w-5 h-5 mr-2"> å…ˆç”Ÿ</label>
                        <label class="flex items-center"><input type="radio" name="userTitle" value="å°å§" class="w-5 h-5 mr-2"> å°å§</label>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="form-control">
                        <label>å§“æ°<span class="text-red-500">*</span></label>
                        <input type="text" id="userName" placeholder="ç‹">
                    </div>
                    <div class="form-control">
                        <label>é›»è©±<span class="text-red-500">*</span></label>
                        <input type="tel" id="userPhone" placeholder="0912...">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="form-control">
                        <label>è»Šç‰Œè™Ÿç¢¼<span class="text-red-500">*</span></label>
                        <input type="text" id="licensePlate" placeholder="ABC-1234">
                    </div>
                    <div class="form-control">
                        <label>ç›®å‰å…¬é‡Œæ•¸ <span class="text-gray-400 font-normal">(é¸å¡«)</span></label>
                        <input type="number" id="mileage" placeholder="ä¾‹å¦‚: 5000">
                    </div>
                </div>

                <!-- æ–°å¢ Email æ¬„ä½ (å¿…å¡«) -->
                <div class="form-control">
                    <label>é›»å­éƒµä»¶ (Email)<span class="text-red-500">*</span></label>
                    <input type="email" id="userEmail" placeholder="example@mail.com">
                </div>

                <div class="form-control">
                    <label>è»Šæ¬¾/è»Šå‹<span class="text-red-500">*</span></label>
                    <input type="text" id="carModel" placeholder="ä¾‹å¦‚: å‹æˆ°å…­ä»£">
                </div>

                <div class="form-control">
                    <label>å…¶ä»–å‚™è¨»</label>
                    <textarea id="otherText" rows="2" placeholder="è³è»Šæˆ–å…¶ä»–éœ€æ±‚ã€æŒ‡å®šè¼ªèƒç­‰èªªæ˜..."></textarea>
                </div>
                
                <p id="errorMsg" class="text-xs text-red-600 font-bold mb-4 hidden text-center">âš ï¸ è«‹å‹™å¿…å¡«å¯«æ‰€æœ‰å¸¶æ˜Ÿè™Ÿ (*) çš„æ¬„ä½</p>
                
                <button id="finalSubmitBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg text-lg shadow-lg transition-all active:scale-95">
                    ç¢ºèªè³‡æ–™ç„¡èª¤ï¼Œç«‹å³é ç´„é€å‡º
                </button>
            </div>
        </div>
        
    </div>

    <script>
        const makeWebhookUrl = "https://hook.us2.make.com/zckx5waq6hex9uk74n4wg15fvdy02u2r";

        const canvas = document.getElementById('reservationCanvas');
        const ctx = canvas.getContext('2d');
        const datePicker = document.getElementById('datePicker');
        const step1Control = document.getElementById('step1Control');
        const step4Control = document.getElementById('step4Control');
        const errorMsg = document.getElementById('errorMsg');
        const lineLinkOverlay = document.getElementById('lineLinkOverlay');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const finalSubmitBtn = document.getElementById('finalSubmitBtn');
        const customModal = document.getElementById('customModal');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');

        let currentStep = 1;
        const serviceItems = ['è¼ªèƒ', 'ç…è»Šçš®', 'é›»æ± ', 'æ©Ÿæ²¹', 'ç«æ˜Ÿå¡', 'çš®å¸¶', 'ç©ºæ¿¾', 'ç¢Ÿç›¤', 'å‚³å‹•', 'æ¸…æ´—ç¯€æµé–¥', 'æ¸…æ´—å™´æ²¹å˜´', 'ç…è»Šæ²¹', 'é©—æ’æ°£', 'å‰å‰ä¿é¤Š', 'è³è»Š', 'å…¶å®ƒ'];
        
        let selectedStore = null;
        let selectedTime = null;
        let selectedItems = {};
        let uiWarning = "";

        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(today.getDate() + 1);
        const thirtyDaysLater = new Date(tomorrow);
        thirtyDaysLater.setDate(tomorrow.getDate() + 30);

        datePicker.min = tomorrow.toISOString().split('T')[0];
        datePicker.max = thirtyDaysLater.toISOString().split('T')[0];
        datePicker.value = tomorrow.toISOString().split('T')[0];

        function isSunday() { return new Date(datePicker.value).getDay() === 0; }
        function isSaturday() { return new Date(datePicker.value).getDay() === 6; }

        function checkHoliday() {
            const d = new Date(datePicker.value);
            const md = `${d.getMonth()+1}/${d.getDate()}`;
            const y = d.getFullYear();
            if (md === "1/1") return "å…ƒæ—¦å…¬ä¼‘";
            if (md === "4/4" || md === "4/5") return "æ¸…æ˜å‡æœŸå…¬ä¼‘";
            if (y === 2025) {
                if (md === "5/31") return "ç«¯åˆç¯€å…¬ä¼‘";
                if (md === "10/6") return "ä¸­ç§‹ç¯€å…¬ä¼‘";
            }
            return null;
        }
        
        function drawStep1() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            step1Control.style.display = 'block';
            step4Control.style.display = 'none';
            lineLinkOverlay.style.display = 'none';
            
            ctx.fillStyle = '#3b82f6'; ctx.font = 'bold 26px sans-serif';
            ctx.fillText('è«‹ç¢ºèªé ç´„æ—¥æœŸ', 40, 60);
            
            const holiday = checkHoliday();
            if (isSunday()) {
                ctx.fillStyle = '#ef4444'; ctx.font = 'bold 22px sans-serif';
                ctx.fillText('âŒ æŠ±æ­‰ï¼Œé€±æ—¥å…¨åº—å…¬ä¼‘', 40, 110);
            } else if (holiday) {
                ctx.fillStyle = '#ef4444'; ctx.font = 'bold 22px sans-serif';
                ctx.fillText(`âŒ æŠ±æ­‰ï¼Œ${holiday}`, 40, 110);
            } else {
                ctx.fillStyle = '#10b981'; ctx.font = 'bold 22px sans-serif';
                ctx.fillText(`âœ… å·²é¸æ“‡ï¼š${datePicker.value}`, 40, 110);
            }

            if (uiWarning) {
                ctx.fillStyle = '#ef4444'; ctx.font = 'bold 18px sans-serif';
                ctx.fillText(`âš ï¸ ${uiWarning}`, 40, 590);
            }

            drawButton(40, 640, 470, 60, '#3b82f6', 'ä¸‹ä¸€æ­¥ï¼šé¸æ“‡åº—é¢/æ™‚é–“', true);
        }

        function drawStep2() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            step1Control.style.display = 'none';
            
            ctx.fillStyle = '#3b82f6'; ctx.font = 'bold 26px sans-serif';
            ctx.fillText('æ­¥é©Ÿ 2: åˆ†åº—èˆ‡æ™‚æ®µ', 40, 50);

            ctx.fillStyle = '#1f2937'; ctx.font = 'bold 18px sans-serif';
            ctx.fillText('1. é¸æ“‡é ç´„åˆ†åº—:', 40, 95);
            drawStoreOption(40, 115, 'é‡‘æ—ºæ˜‡', selectedStore === 'é‡‘æ—ºæ˜‡');
            drawStoreOption(40, 185, 'å¿åº—', selectedStore === 'å¿åº—');
            drawStoreOption(40, 255, 'é‡‘åŠ›ç››', selectedStore === 'é‡‘åŠ›ç››', isSaturday());

            if (selectedStore) {
                ctx.fillStyle = '#1f2937'; ctx.font = 'bold 18px sans-serif';
                ctx.fillText('2. é¸æ“‡é ç´„æ™‚æ®µ:', 40, 350);
                
                let slots = ['10:00', '12:00', '14:00', '16:00', '18:00'];
                slots.forEach((t, i) => {
                    let col = i%3, row = Math.floor(i/3);
                    let sx = 40 + col*165, sy = 380 + row*75;
                    let isSel = selectedTime === t;
                    ctx.fillStyle = isSel ? '#fb923c' : '#f3f4f6';
                    ctx.beginPath(); ctx.roundRect(sx, sy, 150, 60, 8); ctx.fill();
                    ctx.strokeStyle = isSel ? '#ea580c' : '#d1d5db';
                    ctx.strokeRect(sx, sy, 150, 60);
                    ctx.fillStyle = isSel ? 'white' : '#4b5563';
                    ctx.font = 'bold 22px sans-serif';
                    ctx.fillText(t, sx+45, sy+38);
                });
            }

            if (uiWarning) {
                ctx.fillStyle = '#ef4444'; ctx.font = 'bold 18px sans-serif';
                ctx.fillText(`âš ï¸ ${uiWarning}`, 40, 590);
            }

            drawButton(40, 640, 150, 60, '#9ca3af', 'ä¸Šä¸€æ­¥', true);
            drawButton(210, 640, 300, 60, '#3b82f6', 'ä¸‹ä¸€æ­¥ï¼šé¸é …ç›®', true);
        }

        function drawStep3() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#3b82f6'; ctx.font = 'bold 26px sans-serif';
            ctx.fillText('æ­¥é©Ÿ 3: é¸æ“‡æœå‹™é …ç›®', 40, 50);

            ctx.fillStyle = '#ef4444'; ctx.font = 'bold 15px sans-serif';
            ctx.fillText('â€» è‹¥é¸ã€Œè³è»Šã€ï¼Œè«‹æ–¼æœ€å¾Œå‚™è¨»æ¬„å¡«å¯«æ¬²çœ‹æ©Ÿå‹å‹è™Ÿ', 40, 85);
            ctx.fillText('â€» è‹¥é¸ã€Œè¼ªèƒã€ä¸”æœ‰æŒ‡å®šèƒå‹ï¼Œè«‹æ–¼å‚™è¨»æ¬„å¡«å¯«å‹è™Ÿ', 40, 110);
            
            serviceItems.forEach((item, i) => {
                let col = i%2, row = Math.floor(i/2);
                let x = 40 + col*240, y = 140 + row*45;
                ctx.strokeStyle = '#3b82f6'; ctx.lineWidth = 2;
                ctx.strokeRect(x, y, 26, 26);
                if (selectedItems[item]) { ctx.fillStyle = '#3b82f6'; ctx.fillRect(x+4, y+4, 18, 18); }
                ctx.fillStyle = '#1f2937'; ctx.font = '19px sans-serif';
                ctx.fillText(item, x+40, y+21);
            });

            drawButton(40, 640, 150, 60, '#9ca3af', 'ä¸Šä¸€æ­¥', true);
            drawButton(210, 640, 300, 60, '#3b82f6', 'ä¸‹ä¸€æ­¥ï¼šå¡«è³‡æ–™', true);
        }

        function drawStep4() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            step4Control.style.display = 'block';
            ctx.fillStyle = '#3b82f6'; ctx.font = 'bold 26px sans-serif';
            ctx.fillText('æ­¥é©Ÿ 4: é ç´„æ‘˜è¦ç¢ºèª', 40, 50);
            
            ctx.fillStyle = '#f9fafb'; ctx.fillRect(40, 75, 470, 140);
            ctx.strokeStyle = '#e5e7eb'; ctx.strokeRect(40, 75, 470, 140);
            
            ctx.fillStyle = '#1e40af'; ctx.font = 'bold 18px sans-serif';
            ctx.fillText(`ğŸ“… é ç´„æ—¥æœŸï¼š${datePicker.value}`, 60, 115);
            ctx.fillText(`ğŸ“ é ç´„åœ°é»ï¼š${selectedStore} / ${selectedTime}`, 60, 150);
            const items = Object.keys(selectedItems).filter(k=>selectedItems[k]).join('ã€');
            ctx.font = '15px sans-serif'; ctx.fillStyle = '#4b5563';
            ctx.fillText(`ğŸ”§ é …ç›®ï¼š${items.length > 30 ? items.substring(0, 28) + '...' : items}`, 60, 185);

            drawButton(40, 640, 470, 60, '#9ca3af', 'å›ä¸Šä¸€æ­¥ä¿®æ”¹é …ç›®', true);
        }

        async function sendReservationToMake() {
            loadingOverlay.style.display = 'flex';
            const payload = {
                reservationDate: datePicker.value,
                store: selectedStore,
                timeSlot: selectedTime,
                services: Object.keys(selectedItems).filter(k => selectedItems[k]),
                customer: {
                    name: document.getElementById('userName').value,
                    title: document.querySelector('input[name="userTitle"]:checked').value,
                    phone: document.getElementById('userPhone').value,
                    licensePlate: document.getElementById('licensePlate').value,
                    mileage: document.getElementById('mileage').value || "æœªæä¾›",
                    email: document.getElementById('userEmail').value,
                    carModel: document.getElementById('carModel').value,
                    note: document.getElementById('otherText').value || "ç„¡"
                }
            };

            try {
                await fetch(makeWebhookUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                loadingOverlay.style.display = 'none';
                currentStep = 5; drawSuccess();
            } catch (error) {
                loadingOverlay.style.display = 'none';
                alert("é ç´„ç™¼é€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            }
        }

        function drawSuccess() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            step4Control.style.display = 'none';
            ctx.fillStyle = '#10b981'; ctx.font = 'bold 32px sans-serif';
            ctx.fillText('âœ… é ç´„ç”³è«‹å·²é€å‡º', 60, 100);
            ctx.fillStyle = '#374151'; ctx.font = '18px sans-serif';
            ctx.fillText('å®¢æœäººå“¡å°‡å„˜é€Ÿèˆ‡æ‚¨ç¢ºèªæ™‚æ®µã€‚', 60, 160);
            ctx.fillText('è«‹å‹™å¿…é»æ“Šä¸‹æ–¹åŠ å…¥å®˜æ–¹ LINEï¼š', 60, 195);
            
            ctx.fillStyle = '#06C755'; ctx.beginPath(); ctx.roundRect(60, 240, 430, 80, 12); ctx.fill();
            ctx.fillStyle = 'white'; ctx.font = 'bold 26px sans-serif';
            ctx.fillText('ğŸ‘‰ é»æ­¤åŠ å…¥ LINE èŠå¤©å®¤', 120, 290);
            
            updateLineOverlay(); lineLinkOverlay.style.display = 'block';
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function updateLineOverlay() {
            const rect = canvas.getBoundingClientRect();
            const scaleX = rect.width / canvas.width;
            const scaleY = rect.height / canvas.height;
            lineLinkOverlay.style.left = (60 * scaleX) + 'px';
            lineLinkOverlay.style.top = (240 * scaleY) + 'px';
            lineLinkOverlay.style.width = (430 * scaleX) + 'px';
            lineLinkOverlay.style.height = (80 * scaleY) + 'px';
        }

        function drawStoreOption(x, y, name, isSel, isDisabled = false) {
            ctx.fillStyle = isDisabled ? '#f9fafb' : (isSel ? '#3b82f6' : '#ffffff');
            ctx.beginPath(); ctx.roundRect(x, y, 470, 60, 8); ctx.fill();
            ctx.strokeStyle = isDisabled ? '#e5e7eb' : (isSel ? '#2563eb' : '#d1d5db');
            ctx.stroke();
            ctx.fillStyle = isDisabled ? '#9ca3af' : (isSel ? 'white' : '#1f2937');
            ctx.font = 'bold 21px sans-serif';
            ctx.fillText(name, x+20, y+38);
            if (isDisabled) { ctx.font = '15px sans-serif'; ctx.fillText('(é€±å…­åº—ä¼‘)', x+360, y+38); }
        }

        function drawButton(x, y, w, h, color, text, enabled) {
            ctx.fillStyle = enabled ? color : '#e5e7eb';
            ctx.beginPath(); ctx.roundRect(x, y, w, h, 10); ctx.fill();
            ctx.fillStyle = enabled ? 'white' : '#9ca3af';
            ctx.font = 'bold 21px sans-serif';
            const tw = ctx.measureText(text).width;
            ctx.fillText(text, x + (w - tw)/2, y + 38);
        }

        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height);

            if (currentStep === 1) {
                if (x >= 40 && x <= 510 && y >= 640 && y <= 700) {
                    if (isSunday() || checkHoliday()) { uiWarning = isSunday() ? "é€±æ—¥ä¸ç‡Ÿæ¥­" : checkHoliday(); drawStep1(); }
                    else { uiWarning = ""; currentStep = 2; drawStep2(); }
                }
            } else if (currentStep === 2) {
                if (x >= 40 && x <= 510) {
                    if (y >= 115 && y <= 175) { selectedStore = 'é‡‘æ—ºæ˜‡'; selectedTime = null; }
                    else if (y >= 185 && y <= 245) { selectedStore = 'å¿åº—'; selectedTime = null; }
                    else if (y >= 255 && y <= 315 && !isSaturday()) { selectedStore = 'é‡‘åŠ›ç››'; selectedTime = null; }
                }
                if (selectedStore && y >= 380 && y <= 530) {
                    ['10:00', '12:00', '14:00', '16:00', '18:00'].forEach((t, i) => {
                        let col = i%3, row = Math.floor(i/3), sx = 40 + col*165, sy = 380 + row*75;
                        if (x >= sx && x <= sx+150 && y >= sy && y <= sy+60) selectedTime = t;
                    });
                }
                if (x >= 40 && x <= 150 && y >= 640 && y <= 700) { currentStep = 1; drawStep1(); }
                else if (x >= 210 && x <= 510 && y >= 640 && y <= 700) {
                    if (!selectedStore || !selectedTime) { uiWarning = "è«‹é¸åº—é¢èˆ‡æ™‚æ®µ"; drawStep2(); }
                    else { currentStep = 3; drawStep3(); }
                } else drawStep2();
            } else if (currentStep === 3) {
                serviceItems.forEach((item, i) => {
                    let col = i%2, row = Math.floor(i/2), ix = 40 + col*240, iy = 140 + row*45;
                    if (x >= ix && x <= ix + 200 && y >= iy && y <= iy + 45) selectedItems[item] = !selectedItems[item];
                });
                if (x >= 40 && x <= 190 && y >= 640 && y <= 700) { currentStep = 2; drawStep2(); }
                else if (x >= 210 && x <= 510 && y >= 640 && y <= 700) {
                    if (!Object.values(selectedItems).some(v => v)) drawStep3();
                    else {
                        if (selectedItems['æ¸…æ´—ç¯€æµé–¥'] || selectedItems['æ¸…æ´—å™´æ²¹å˜´'] || selectedItems['å‰å‰ä¿é¤Š']) customModal.style.display = 'flex';
                        else { currentStep = 4; drawStep4(); window.scrollTo({top: 400, behavior: 'smooth'}); }
                    }
                } else drawStep3();
            } else if (currentStep === 4) {
                if (x >= 40 && x <= 510 && y >= 640 && y <= 700) { currentStep = 3; drawStep3(); }
            }
        });

        modalConfirmBtn.addEventListener('click', () => { customModal.style.display = 'none'; currentStep = 4; drawStep4(); window.scrollTo({top: 400, behavior: 'smooth'}); });
        finalSubmitBtn.addEventListener('click', () => {
            // åŠ å…¥ userEmail æª¢æŸ¥
            const reqFields = ['userName','userPhone','licensePlate','carModel', 'userEmail'];
            const allFilled = reqFields.every(id => document.getElementById(id).value.trim() !== "");
            
            if (!allFilled) {
                errorMsg.classList.remove('hidden');
            } else {
                errorMsg.classList.add('hidden');
                sendReservationToMake();
            }
        });

        datePicker.addEventListener('change', () => { if(currentStep === 1) drawStep1(); });
        window.addEventListener('resize', () => { if (currentStep === 5) updateLineOverlay(); });
        drawStep1();
    </script>
</body>
</html>